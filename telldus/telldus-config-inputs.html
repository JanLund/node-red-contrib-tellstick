<!--
  Copyright 2013,2014 IBM Corp.

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/x-red" data-template-name="telldus-config-inputs">

    <style>

        /* Force scrollbar on Mac OS X, so that the user understand what's going on */
        ::-webkit-scrollbar {
          -webkit-appearance: none;
          width: 7px;
        }
        ::-webkit-scrollbar-thumb {
          border-radius: 4px;
          background-color: rgba(0, 0, 0, .5);
          -webkit-box-shadow: 0 0 1px rgba(255, 255, 255, .5);
        }

        .telldus-code {
            font-family: Consolas, "Andale Mono WT", "Andale Mono", "Lucida Console", "Lucida Sans Typewriter", "DejaVu Sans Mono", "Bitstream Vera Sans Mono", "Liberation Mono", "Nimbus Mono L", Monaco, "Courier New", Courier, monospace;
        }

        #incoming-transmission-wrapper {
            width: calc(80% - 2em);
            float: left;
            padding-left: 1em;
            margin-left: 1em;
        }

        #listen-button-wrapper {
            text-align: center;
        }

        .incoming-box {
            max-height: 360px;
            overflow: scroll;
            border-top: 1px solid #dddddd;
            margin-top: 1em;
        }

        .transmission-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0 0.5em;
        }

        .transmission-table th {
            text-align: left;
            font-weight: normal;
        }

        .transmission-table tbody tr {
            background-color: #fafafa;
        }

        .transmission-table tbody tr:hover {
            background-color: rgb(250, 255, 209);
        }

        .transmission-table tbody td {
            padding: 0.5em 0.3em;
            border-bottom: 1px solid #ddd;
            border-top: 1px solid #ddd;
        }

        .transmission-table tbody td.first {
            border-left: 1px solid #ddd;
            -webkit-border-top-left-radius: 5px;
            -webkit-border-bottom-left-radius: 5px;
            -moz-border-radius-topleft: 5px;
            -moz-border-radius-bottomleft: 5px;
            border-top-left-radius: 5px;
            border-bottom-left-radius: 5px;
        }

        .transmission-table tbody td.last {
            border-right: 1px solid #ddd;
            -webkit-border-top-right-radius: 5px;
            -webkit-border-bottom-right-radius: 5px;
            -moz-border-radius-topright: 5px;
            -moz-border-radius-bottomright: 5px;
            border-top-right-radius: 5px;
        }

        .form-row .input-code {
            font-family: Consolas, "Andale Mono WT", "Andale Mono", "Lucida Console", "Lucida Sans Typewriter", "DejaVu Sans Mono", "Bitstream Vera Sans Mono", "Liberation Mono", "Nimbus Mono L", Monaco, "Courier New", Courier, monospace;
        }

        .manual-inputs {
            width: 20%;
            float: left;
        }

        .manual-inputs .form-row input {
            width: calc(100% - 120px);
        }

        .listen-button-listen {
            display: none;
        }

        .form-tips {
            clear: both;
            max-width: calc(20% - 18px);
        }

    </style>

    <div class="manual-inputs">

        <div class="form-row">
            <label for="node-config-input-name"><i class="fa fa-tag"></i> Name</label>
            <input type="text" id="node-config-input-name" placeholder="My Sensor">
        </div>
        <div class="form-row">
            <label for="node-config-input-deviceclass"><i class="fa fa-dot-circle-o"></i> Class</label>
            <input class="device-property input-code" type="text" id="node-config-input-deviceclass">
        </div>
        <div class="form-row">
            <label for="node-config-input-deviceprotocol"><i class="fa fa-dot-circle-o"></i> Protocol</label>
            <input class="device-property input-code" type="text" id="node-config-input-deviceprotocol">
        </div>
        <div class="form-row">
            <label for="node-config-input-devicegroup"><i class="fa fa-dot-circle-o"></i> Group</label>
            <input class="device-property input-code" type="text" id="node-config-input-devicegroup">
        </div>
        <div class="form-row">
            <label for="node-config-input-devicehouse"><i class="fa fa-dot-circle-o"></i> House</label>
            <input class="device-property input-code" type="text" id="node-config-input-devicehouse">
        </div>
        <div class="form-row">
            <label for="node-config-input-devicemethod"><i class="fa fa-dot-circle-o"></i> Method</label>
            <input class="device-property input-code" type="text" id="node-config-input-devicemethod">
        </div>
        <div class="form-row">
            <label for="node-config-input-devicemodel"><i class="fa fa-dot-circle-o"></i> Model</label>
            <input class="device-property input-code" type="text" id="node-config-input-devicemodel">
        </div>
        <div class="form-row">
            <label for="node-config-input-deviceunit"><i class="fa fa-dot-circle-o"></i> Unit</label>
            <input class="device-property input-code" type="text" id="node-config-input-deviceunit">
        </div>
        <div class="form-row">
            <label for="node-config-input-devicecode"><i class="fa fa-dot-circle-o"></i> Code</label>
            <input class="device-property input-code" type="text" id="node-config-input-devicecode">
        </div>
        <div class="form-row">
            <label for="node-config-input-deviceid"><i class="fa fa-dot-circle-o"></i> Id</label>
            <input class="device-property input-code" type="text" id="node-config-input-deviceid">
        </div>
    </div>

    <div id="incoming-transmission-wrapper">

        <div id="listen-button-wrapper">
            <button type="button" id="telldus-listen" class="ui-button ui-widget ui-state-default ui-corner-all ui-button-text-only" role="button" aria-disabled="false">
                <span class="ui-button-text"><span class="listen-button-listen">Listen</span><span class="listen-button-stop"><i class="fa fa-spinner fa-spin"></i> Stop listening</span></span>
            </button>
        </div>

        <div id="incoming-transmission">
            <div class="incoming-box">
                <table class="command-table transmission-table">
                    <thead>
                        <tr>
                            <th>&nbsp;</th>
                            <th>&nbsp;</th>
                            <th>protocol</th>
                            <th>model</th>
                            <th>id</th>
                            <th>house</th>
                            <th>group</th>
                            <th>unit</th>
                            <th>code</th>
                            <th>method</th>
                            <th>other data</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
</script>

<script type="text/javascript">
    RED.nodes.registerType('telldus-config-inputs',{
        category: 'config',
        defaults: {
            name: {
                value: "",
                required: true
            },
            deviceclass: {value: ""},
            deviceprotocol: {value: ""},
            devicegroup: {value: ""},
            devicehouse: {value: ""},
            devicemethod: {value: ""},
            devicemodel: {value: ""},
            deviceunit: {value: ""},
            devicecode: {value: ""},
            deviceid: {value: ""}
        },
        label: function() {
            return this.name || 'not set';
        },
        oneditprepare: function() {
            'use strict';
            var node = this;
            var isListening = true;

            function prettyPrintCode(codeStr) {
                if (codeStr === undefined) {
                    return '';
                }
                return '<span class="telldus-code">' + codeStr + '</span>';
            }

            function printRemainingProperties(obj) {
                var html = '';
                var keys = Object.keys(obj);
                if (keys.length > 0) {
                    html += '<td class="last">';
                    html += keys.map(function (key) {
                        return key + ': ' + prettyPrintCode(obj[key]);
                    }).join('<br>');
                    html += '</td>';
                } else {
                    html += '<td class="last">&nbsp;</td>';
                }
                return html;
            }

            // Increse dialog window size. This is not done all that beautiful...
            setTimeout(function () {
                var jqCurDialog = $("[aria-describedby='node-config-dialog']");
                var dialogWidth = ($(window).width() - 100);
                if (dialogWidth > 1400) {
                    dialogWidth = 1400;
                }
                jqCurDialog.css('width', dialogWidth);
                jqCurDialog.css('left', (($(window).width() - dialogWidth) / 2));
                jqCurDialog.css('top', (($(window).height() - 580) / 2));
                jqCurDialog.css('min-height', '580px');
            }, 0);

            /**
             * Click on 'Learn'
             */
            $('body').on('click', '.learn-button', function() {
                // Empty any previous values
                $('.device-property').val('');

                var data = $(this).data('data').split(';');
                var dataObj = {};
                data.forEach(function (kvp) {
                    $('#node-config-input-device' + kvp.split(':')[0]).val(kvp.split(':')[1]);
                });
            });



            // Print on incoming data
            this.incomingData = function(topic, data) {

                if (!isListening) { return; }

                data = data.slice(0, -1);
                var dataObj = {};
                data.split(';').forEach(function (kvp) {
                    dataObj[kvp.split(':')[0]] = kvp.split(':')[1];
                });

                var learnButtonIcon;
                if (dataObj.class === 'command') {
                    learnButtonIcon = 'fa-mobile';
                } else if (dataObj.class === 'sensor') {
                    learnButtonIcon = 'fa-bar-chart';
                } else {
                    learnButtonIcon = 'fa-bullseye';
                }
                        //

                var html = '<tr>';
                    html += '<td class="first">' +
                    '<button data-data="' + data + '" type="button" id="" class="learn-button ui-button ui-widget ui-state-default ui-corner-all ui-button-text-only" role="button" aria-disabled="false">' +
                    '<span class="ui-button-text">Learn</span>' +
                    '</button>' +
                    '</td>' +
                    '<td>' + '<i class="fa ' + learnButtonIcon + '"></i>' + '</td>' +
                    '<td>' + prettyPrintCode(dataObj.protocol) + '</td>' +
                    '<td>' + prettyPrintCode(dataObj.model) + '</td>' +
                    '<td>' + prettyPrintCode(dataObj.id) + '</td>' +
                    '<td>' + prettyPrintCode(dataObj.house) + '</td>' +
                    '<td>' + prettyPrintCode(dataObj.group) + '</td>' +
                    '<td>' + prettyPrintCode(dataObj.unit) + '</td>' +
                    '<td>' + prettyPrintCode(dataObj.code) + '</td>' +
                    '<td>' + prettyPrintCode(dataObj.method) + '</td>' +

                    delete dataObj.class;
                    delete dataObj.protocol;
                    delete dataObj.id;
                    delete dataObj.group;
                    delete dataObj.house;
                    delete dataObj.method;
                    delete dataObj.model;
                    delete dataObj.unit;
                    delete dataObj.code;
                    html += printRemainingProperties(dataObj);
                    html += '</tr>';
                    $('.command-table tbody').prepend(html);
            };

            /**
             * Listen
             */

            RED.comms.subscribe("telldus-transmission", this.incomingData);
            $.getJSON('telldus/listen', function(data) {
                if (data.status > 0) {
                    RED.notify('<strong>Telldus error</strong>: ' + data.errStr, 'error');
                }
            });


            // Set up heartbeat, if hearbeat is lost, server will stop sending data.
            this.telldusDeviceListenHeartbeatInterval = setInterval(function(){
                $.getJSON('telldus/listen-heartbeat', function(data) {});
            }, 3000);



            $('#telldus-listen').click(function () {
                if (isListening) {
                    isListening = false;
                    $('.listen-button-listen').show();
                    $('.listen-button-stop').hide();
                } else {
                    isListening = true;
                    $('.listen-button-listen').hide();
                    $('.listen-button-stop').show();
                }
            });



            /**
             * Node-RED does not count a click on the upper right hand X button as a cancel action
             */
            var that = this;
            $('.ui-dialog-titlebar-close').click(function () {
                clearInterval(that.telldusDeviceListenHeartbeatInterval);
                RED.comms.unsubscribe("telldus-transmission", that.incomingData);
            });



        },
        oneditcancel: function() {
            console.log('cancel');
            clearInterval(this.telldusDeviceListenHeartbeatInterval);
            RED.comms.unsubscribe("telldus-transmission", this.incomingData);
        },
        oneditsave: function() {
            console.log('close');
            clearInterval(this.telldusDeviceListenHeartbeatInterval);
            RED.comms.unsubscribe("telldus-transmission", this.incomingData);
        }
    });
</script>
