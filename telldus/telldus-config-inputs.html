<!--
  Copyright 2013,2014 IBM Corp.

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/x-red" data-template-name="telldus-config-inputs">

    <style>

        /* Force scrollbar on Mac OS X, so that the user understand what's going on */
        ::-webkit-scrollbar {
          -webkit-appearance: none;
          width: 7px;
        }
        ::-webkit-scrollbar-thumb {
          border-radius: 4px;
          background-color: rgba(0, 0, 0, .5);
          -webkit-box-shadow: 0 0 1px rgba(255, 255, 255, .5);
        }

        .telldus-code {
            font-family: Consolas, "Andale Mono WT", "Andale Mono", "Lucida Console", "Lucida Sans Typewriter", "DejaVu Sans Mono", "Bitstream Vera Sans Mono", "Liberation Mono", "Nimbus Mono L", Monaco, "Courier New", Courier, monospace;
        }

        #incoming-transmission-wrapper {
            margin-top: 1em;
            width: calc(70% - 2em);
            float: left;
            padding-left: 1em;
            margin-left: 1em;
        }

        #incoming-transmission {
            display: none;
        }

        #listen-button-wrapper {
            border-bottom: 1px solid #aaa;
            padding-bottom: 1em;
            text-align: center;
        }

        .incoming-box {
            max-height: 185px;
            overflow: scroll;
            border: 1px solid #dddddd;
            padding: 0 0.5em 0 0.5em;
            margin-bottom: 1em;
        }

        .transmission-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0 0.5em;
        }

        .transmission-table th {
            text-align: left;
            font-weight: normal;
        }

        .transmission-table tbody tr {
            background-color: #fafafa;
        }

        .transmission-table tbody tr:hover {
            background-color: rgb(250, 255, 209);
        }

        .transmission-table tbody td {
            padding: 0.5em 0.3em;
            border-bottom: 1px solid #ddd;
            border-top: 1px solid #ddd;
        }

        .transmission-table tbody td.first {
            border-left: 1px solid #ddd;
            -webkit-border-top-left-radius: 5px;
            -webkit-border-bottom-left-radius: 5px;
            -moz-border-radius-topleft: 5px;
            -moz-border-radius-bottomleft: 5px;
            border-top-left-radius: 5px;
            border-bottom-left-radius: 5px;
        }

        .transmission-table tbody td.last {
            border-right: 1px solid #ddd;
            -webkit-border-top-right-radius: 5px;
            -webkit-border-bottom-right-radius: 5px;
            -moz-border-radius-topright: 5px;
            -moz-border-radius-bottomright: 5px;
            border-top-right-radius: 5px;
        }

        .form-row .input-code {
            font-family: Consolas, "Andale Mono WT", "Andale Mono", "Lucida Console", "Lucida Sans Typewriter", "DejaVu Sans Mono", "Bitstream Vera Sans Mono", "Liberation Mono", "Nimbus Mono L", Monaco, "Courier New", Courier, monospace;
        }

        .manual-inputs {
            width: 30%;
            float: left;
        }

        .manual-inputs .form-row input {
            width: calc(100% - 120px);
        }

        .listen-button-stop {
            display: none;
        }

        .form-tips {
            clear: both;
        }

    </style>

    <div class="manual-inputs">

        <div class="form-row">
            <label for="node-config-input-name"><i class="fa fa-tag"></i> Name</label>
            <input type="text" id="node-config-input-name" placeholder="My Sensor">
        </div>
        <div class="form-row">
            <label for="node-config-input-deviceclass"><i class="fa fa-dot-circle-o"></i> Class</label>
            <input class="device-property input-code" type="text" id="node-config-input-deviceclass">
        </div>
        <div class="form-row">
            <label for="node-config-input-deviceprotocol"><i class="fa fa-dot-circle-o"></i> Protocol</label>
            <input class="device-property input-code" type="text" id="node-config-input-deviceprotocol">
        </div>
        <div class="form-row">
            <label for="node-config-input-devicegroup"><i class="fa fa-dot-circle-o"></i> Group</label>
            <input class="device-property input-code" type="text" id="node-config-input-devicegroup">
        </div>
        <div class="form-row">
            <label for="node-config-input-devicehouse"><i class="fa fa-dot-circle-o"></i> House</label>
            <input class="device-property input-code" type="text" id="node-config-input-devicehouse">
        </div>
        <div class="form-row">
            <label for="node-config-input-devicemethod"><i class="fa fa-dot-circle-o"></i> Method</label>
            <input class="device-property input-code" type="text" id="node-config-input-devicemethod">
        </div>
        <div class="form-row">
            <label for="node-config-input-devicemodel"><i class="fa fa-dot-circle-o"></i> Model</label>
            <input class="device-property input-code" type="text" id="node-config-input-devicemodel">
        </div>
        <div class="form-row">
            <label for="node-config-input-deviceunit"><i class="fa fa-dot-circle-o"></i> Unit</label>
            <input class="device-property input-code" type="text" id="node-config-input-deviceunit">
        </div>
        <div class="form-row">
            <label for="node-config-input-devicecode"><i class="fa fa-dot-circle-o"></i> Code</label>
            <input class="device-property input-code" type="text" id="node-config-input-devicecode">
        </div>
        <div class="form-row">
            <label for="node-config-input-deviceid"><i class="fa fa-dot-circle-o"></i> Id</label>
            <input class="device-property input-code" type="text" id="node-config-input-deviceid">
        </div>
    </div>

    <div id="incoming-transmission-wrapper">

        <div id="listen-button-wrapper">
            <button type="button" id="telldus-listen" class="ui-button ui-widget ui-state-default ui-corner-all ui-button-text-only" role="button" aria-disabled="false">
                <span class="ui-button-text"><span class="listen-button-listen">Listen</span><span class="listen-button-stop"><i class="fa fa-spinner fa-spin"></i> Listening... Click to stop</span></span>
            </button>
        </div>

        <div id="incoming-transmission">
            <h5>Commands</h5>
            <div class="incoming-box">
                <table class="command-table transmission-table">
                    <thead>
                        <tr>
                            <th>&nbsp;</th>
                            <th>protocol</th>
                            <th>model</th>
                            <th>house</th>
                            <th>group</th>
                            <th>unit</th>
                            <th>code</th>
                            <th>method</th>
                            <th>other data</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <h5>Sensors</h5>
            <div class="incoming-box">
                <table class="sensor-table transmission-table">
                    <thead>
                        <tr>
                            <th>&nbsp;</th>
                            <th>protocol</th>
                            <th>id</th>
                            <th>model</th>
                            <th>other data</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
</script>

<script type="text/javascript">
    RED.nodes.registerType('telldus-config-inputs',{
        category: 'config',
        defaults: {
            name: {
                value: "",
                required: true
            },
            deviceclass: {value: ""},
            deviceprotocol: {value: ""},
            devicegroup: {value: ""},
            devicehouse: {value: ""},
            devicemethod: {value: ""},
            devicemodel: {value: ""},
            deviceunit: {value: ""},
            devicecode: {value: ""},
            deviceid: {value: ""}
        },
        label: function() {
            return this.name || 'not set';
        },
        oneditprepare: function() {


            function prettyPrintCode(codeStr) {
                if (codeStr === undefined) {
                    return '';
                }

                var isBinary = /^[01]+$/.test(codeStr);
                if (isBinary === false || codeStr == 0 || codeStr == 1) {
                    return '<span class="telldus-code">' + codeStr + '</span>';
                }
                return '<span class="telldus-code">' + codeStr + '</span> (=' + parseInt(codeStr, 2) + ')';
            }

            function printRemainingProperties(obj) {
                var html = '';
                var keys = Object.keys(obj);
                if (keys.length > 0) {
                    html += '<td class="last">';
                    html += keys.map(function (key) {
                        return key + ': ' + prettyPrintCode(obj[key]);
                    }).join(' | ');
                    html += '</td>';
                } else {
                    html += '<td class="last">&nbsp;</td>';
                }
                return html;
            }

            var node = this;
            var isListening = false;

            // Increse dialog window size. This is not done all that beautiful...
            setTimeout(function () {
                jqCurDialog = $("[aria-describedby='node-config-dialog']");
                var dialogWidth = ($(window).width() - 100);
                if (dialogWidth > 1400) {
                    dialogWidth = 1400;
                }
                jqCurDialog.css('width', dialogWidth);
                jqCurDialog.css('left', (($(window).width() - dialogWidth) / 2));
                jqCurDialog.css('top', '50px');
                jqCurDialog.css('min-height', ($(window).height() - 100));
            }, 0);

            /**
             * Click on 'Learn'
             */
            $('body').on('click', '.learn-button', function() {
                // Empty any previous values
                $('.device-property').val('');

                data = $(this).data('data').split(';');
                var dataObj = {};
                data.forEach(function (kvp) {
                    $('#node-config-input-device' + kvp.split(':')[0]).val(kvp.split(':')[1]);
                });
            });

            /**
             * Listen
             */
            $('#telldus-listen').click(function () {

                $('#incoming-transmission').show();

                if (isListening) {
                    isListening = false;
                    // todo, usubscribe doesn't seem to work, therefor checking 'if (!isListening) { return; }' further down.
                    RED.comms.unsubscribe("telldus-transmission");
                    $('.listen-button-listen').show();
                    $('.listen-button-stop').hide();

                } else {
                    isListening = true;
                    $('.listen-button-listen').hide();
                    $('.listen-button-stop').show();

                    $.getJSON('telldus/listen', function(data) {
                        if (data.hasOwnProperty('err')) {
                            RED.notify('<strong>Telldus error</strong>: ' + data.err, 'error');
                        }
                    });

                    RED.comms.subscribe("telldus-transmission", function(topic, data) {

                        if (!isListening) { return; }

                        data = data.slice(0, -1);
                        var dataObj = {};
                        data.split(';').forEach(function (kvp) {
                            dataObj[kvp.split(':')[0]] = kvp.split(':')[1];
                        });

                        var html = '<tr>';
                        if (dataObj.class === 'command') {
//                            html += '<td class="first"><a href="#"><i class="fa fa-plus-square"></i> Learn</a></td>' +
                            html += '<td class="first">' +
                            '<button data-data="' + data + '" type="button" id="" class="learn-button ui-button ui-widget ui-state-default ui-corner-all ui-button-text-only" role="button" aria-disabled="false">' +
                            '<span class="ui-button-text">Learn</span>' +
                            '</button>' +
                            '</td>' +
                                    '<td>' + prettyPrintCode(dataObj.protocol) + '</td>' +
                                    '<td>' + prettyPrintCode(dataObj.model) + '</td>' +
                                    '<td>' + prettyPrintCode(dataObj.house) + '</td>' +
                                    '<td>' + prettyPrintCode(dataObj.group) + '</td>' +
                                    '<td>' + prettyPrintCode(dataObj.unit) + '</td>' +
                                    '<td>' + prettyPrintCode(dataObj.code) + '</td>' +
                                    '<td>' + prettyPrintCode(dataObj.method) + '</td>' +

                            delete dataObj.class;
                            delete dataObj.protocol;
                            delete dataObj.group;
                            delete dataObj.house;
                            delete dataObj.method;
                            delete dataObj.model;
                            delete dataObj.unit;
                            delete dataObj.code;
                            html += printRemainingProperties(dataObj);
                            html += '</tr>';
                            $('.command-table tbody').prepend(html);
                        } else {
                            html += '<td class="first">' +
                                        '<button data-data="' + data + '" type="button" id="" class="learn-button ui-button ui-widget ui-state-default ui-corner-all ui-button-text-only" role="button" aria-disabled="false">' +
                                            '<span class="ui-button-text">Learn</span>' +
                                        '</button>' +
                                    '</td>' +
                                    '<td>' + prettyPrintCode(dataObj.protocol) + '</td>' +
                                    '<td>' + prettyPrintCode(dataObj.id) + '</td>' +
                                    '<td>' + prettyPrintCode(dataObj.model) + '</td>' +
                            delete dataObj.class;
                            delete dataObj.protocol;
                            delete dataObj.id;
                            delete dataObj.model;
                            html += printRemainingProperties(dataObj);
                            html += '</tr>';
                            $('.sensor-table tbody').prepend(html);
                        }

                    });
                }

            });



        },
        oneditcancel: function() {
            RED.comms.unsubscribe("telldus-transmission");
        },
        oneditsave: function() {
            RED.comms.unsubscribe("telldus-transmission");
        }
    });
</script>
