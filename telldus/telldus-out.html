
<script type="text/x-red" data-template-name="telldus-out">
    <style>

        .no-close .ui-dialog-titlebar-close {
          display: none;
        }

        #telldus-output-config-devices {
            width: 100%;
        }

        #telldus-output-config-devices th {
            text-align: left;
        }

        #telldus-output-config-devices th.telldus-learn-column {
            text-align: right;
        }

        .telldus-button {
            display: inline-block;
            padding: 3px 5px;
            line-height: 20px;
            height: 20px;
            text-align: center;
            border: 1px solid rgba(0, 0, 0, 0.3);
        }

        .telldus-status-icon-button:hover,
        .telldus-button:hover {
            background-color: rgba(0, 0, 0, 0.1);
        }

        a.telldus-button:hover {
            text-decoration: none;
        }

        .telldus-status-icon {
            padding: 3px;
            font-size: 20px;
            line-height: 20px;
            width: 20px;
            text-align: center;
        }

        .telldus-status-icon-bell {
            font-size: 15px;
        }

        .telldus-status-icon-on {
            background-color: rgba(255, 255, 0, 0.5);
        }

        .telldus-status-icon-off {
            color: rgba(0, 0, 0, 0.3);
        }

        .telldus-status-icon-25 {
            background-color: rgba(255, 255, 0, 0.125);
        }

        .telldus-status-icon-50 {
            background-color: rgba(255, 255, 0, 0.25);
        }

        .telldus-status-icon-75 {
            background-color: rgba(255, 255, 0, 0.375);
        }

        .telldus-learn-column {
            text-align: right;
        }

        .telldus-status-icon-button {
            border: 1px solid rgba(0, 0, 0, 0.3);
            margin-right: 3px;
        }


        .telldus-list-configured-device-dialog .ui-dialog-buttonpane {
            padding-left: 1em;
        }

        .telldus-list-configured-device-dialog .ui-dialog-buttonset {
            width: 100%;
        }

        .telldus-list-configured-device-dialog .ui-dialog-buttonset button {
            float: right;
        }

        #telldus-btn-open-device-list{
            margin: 0 0 10px 106px;
        }

        #telldus-btn-open-device-list,
        .telldus-list-configured-device-dialog .ui-dialog-buttonset button.telldus-btn-add-new-device {
            float: left;
            background-color: #337ab7;
            border: #2e6da4;
            color: white;
            padding: 0.3em 1em;
        }

        #telldus-row-addedit-devices,
        .telldus-addedit-parameter-row {
            display: none;
        }

        .telldus-addedit-parameter-row input[type="text"] {
            width: 206px;
        }

        .telldus-parameter-help-text {
            color: rgba(0, 0, 0, 0.5);
        }

        .telldus-code-block {
            display: block;
            width: 30px;
            float: left;
        }

        .telldus-code-block-wrapper {
            display: inline-block;
            width: 400px;
        }

        .form-row .telldus-code-block label {
            width: 17px;
            text-align: center;
            margin-top: 5px;
        }

        .telldus-code-label {
            vertical-align: top;
        }

    </style>

    <div class="form-row">
        <button id="telldus-btn-open-device-list">Configure/Add Devices</button>
    </div>
    <div class="form-row">
        <label for="node-input-device"><i class="fa fa-lightbulb-o"></i> Device</label>
        <select id="node-input-device">
            <option value=""></option>
        </select>
    </div>
    <div class="form-row node-input-method">
        <label for="node-input-method"><i class="fa fa-magic"></i> Method</label>
        <select id="node-input-method">
            <option value=""></option>
        </select>
    </div>
    <div class="form-row node-input-dimlevel">
        <label for="node-input-dimlevel"><i class="fa fa-sliders"></i> Dim value</label>
        <input type="number" min="0" max="255" step="5" id="node-input-dimlevel" style="width: 9%">
        <input type="range" id="dimlevel-range" min="0" max="255" step="5" style="width: 60%">
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Name">
        <input type="hidden" id="node-input-devicefriendlyname">
    </div>


    <div id="telldus-dialog-list-configured-devices" title="Configured Devices">
        <table id="telldus-output-config-devices">
            <tr>
                <th>Status</th>
                <th>Name</th>
                <th>Perform</th>
                <th class="telldus-learn-column">Learn</th>
            </tr>
        </table>
    </div>

    <div id="telldus-dialog-add-edit-device" title="Add/Edit Device">

        <div class="form-row">
            <label for="telldus-select-supported-brands">Brand</label>
            <select id="telldus-select-supported-brands">
                <option value=""></option>
            </select>
        </div>
        <div id="telldus-row-addedit-devices" class="form-row">
            <label for="telldus-select-supported-devices">Model</label>
            <select id="telldus-select-supported-devices">
                <option value=""></option>
            </select>
        </div>

        <div id="telldus-row-addedit-parameter-house-number" class="form-row telldus-addedit-parameter-row">
            <label for="telldus-addedit-parameter-house-number">House</label>
            <input type="text" id="telldus-addedit-parameter-house-number">
            <button class="telldus-random-button" data-randomfor="telldus-addedit-parameter-house-number">Randomize</button>
            <span class="telldus-parameter-help-text">Help Text</span>
        </div>

        <div id="telldus-row-addedit-parameter-house-letter" class="form-row telldus-addedit-parameter-row">
            <label for="telldus-addedit-parameter-house-letter">House</label>
            <input type="text" id="telldus-addedit-parameter-house-letter">
            <span class="telldus-parameter-help-text">Help Text</span>
        </div>

        <div id="telldus-row-addedit-parameter-unit" class="form-row telldus-addedit-parameter-row">
            <label for="telldus-addedit-parameter-unit">Unit</label>
            <input type="text" id="telldus-addedit-parameter-unit">
            <span class="telldus-parameter-help-text">Help Text</span>
        </div>

        <div id="telldus-row-addedit-parameter-code" class="form-row telldus-addedit-parameter-row">
            <label for="" class="telldus-code-label">Code</label>

            <div class="telldus-code-block-wrapper">

                <div class="telldus-code-block">
                    <input type="radio" name="telldus-code-1" value="true">
                    <input type="radio" name="telldus-code-1" value="false" checked="checked">
                    <label for="telldus-code-1">1</label>
                </div>
                <div class="telldus-code-block">
                    <input type="radio" name="telldus-code-2" value="true">
                    <input type="radio" name="telldus-code-2" value="false" checked="checked">
                    <label for="telldus-code-2">2</label>
                </div>
                <div class="telldus-code-block">
                    <input type="radio" name="telldus-code-3" value="true">
                    <input type="radio" name="telldus-code-3" value="false" checked="checked">
                    <label for="telldus-code-3">3</label>
                </div>
                <div class="telldus-code-block">
                    <input type="radio" name="telldus-code-4" value="true">
                    <input type="radio" name="telldus-code-4" value="false" checked="checked">
                    <label for="telldus-code-4">4</label>
                </div>
                <div class="telldus-code-block">
                    <input type="radio" name="telldus-code-5" value="true">
                    <input type="radio" name="telldus-code-5" value="false" checked="checked">
                    <label for="telldus-code-5">5</label>
                </div>
               <div class="telldus-code-block">
                    <input type="radio" name="telldus-code-6" value="true">
                    <input type="radio" name="telldus-code-6" value="false" checked="checked">
                    <label for="telldus-code-6">A</label>
                </div>
                <div class="telldus-code-block">
                    <input type="radio" name="telldus-code-7" value="true">
                    <input type="radio" name="telldus-code-7" value="false" checked="checked">
                    <label for="telldus-code-7">B</label>
                </div>
                <div class="telldus-code-block">
                    <input type="radio" name="telldus-code-8" value="true">
                    <input type="radio" name="telldus-code-8" value="false" checked="checked">
                    <label for="telldus-code-8">C</label>
                </div>
                <div class="telldus-code-block">
                    <input type="radio" name="telldus-code-9" value="true">
                    <input type="radio" name="telldus-code-9" value="false" checked="checked">
                    <label for="telldus-code-9">D</label>
                </div>
                <div class="telldus-code-block">
                    <input type="radio" name="telldus-code-10" value="true">
                    <input type="radio" name="telldus-code-10" value="false" checked="checked">
                    <label for="telldus-code-10">E</label>
                </div>

            </div>

        </div>

        <p>lorem</p>

    </div>



</script>

<script type="text/x-red" data-help-name="telldus-out">
    <p>Telldus OUT</p>
</script>

<script type="text/javascript">
    RED.nodes.registerType('telldus-out',{
        category: 'output',
        defaults: {
            name: {value:""},
            device: {value:""},
            devicefriendlyname: {value:""},
            method: {value:""},
            dimlevel: {value: 0}
        },
        color:"#abd3ff",
        inputs:1,
        outputs:0,
        icon: "bridge-dash.png",
        align: "right",
        label: function() {
            if (this.name) {
                return this.name;
            } else if (this.devicefriendlyname && this.method) {
                return this.devicefriendlyname + ' [' +  this.method + ']';
            } else if (this.devicefriendlyname) {
                return this.devicefriendlyname;
            } else {
                return "Telldus out";
            }
        },
        labelStyle: function() {
            return this.name?"node_label_italic":"";
        },
        oneditprepare: function() {


            var node = this;






            /* ************************************************************* *\
             *
             *  Original Telldus-Out Dialog
             *
             \* ************************************************************* */


            /**
             *  Event Listener - "Configure/Add Device" Button
             *  Open the "List of Configured Devices" dialog when button
             *  is pressed.
             */
            $("#telldus-btn-open-device-list" ).click(function(event){
                event.preventDefault();
                $( "#telldus-dialog-list-configured-devices" ).dialog( "open" );
            });


            /**
             * Event Listeners - "Device", "Method", "Dim-value"
             * Show/Hide user inputable fields.
             */
            $("#node-input-device").change(function() {
                var curDeviceId = $("#node-input-device").val();
                if (curDeviceId !== null) {
                    $('#node-input-devicefriendlyname').val($('#node-input-device option:selected').text());
                    showHideMethods(curDeviceId, $("#node-input-method").val());
                }
            });
            $("#node-input-method").change(function() {
                var curMethod = $("#node-input-method").val();
                if (curMethod !== null) {
                    showHideDim(curMethod);
                }
            });
            $("#dimlevel-range").change(function() {
                $("#node-input-dimlevel").val($("#dimlevel-range").val());
            });
            $("#node-input-dimlevel").change(function() {
                $("#dimlevel-range").val($("#node-input-dimlevel").val());
            });


            /**
             * Populate methods select box with all methods for the current device
             * or hide it, if no device is selected.
             */
            function showHideMethods(selectedDeviceId, selectedMethod) {
                if (selectedDeviceId) {
                    // Get data for current device
                    var curDevice = devices.filter(function (device) {
                        return device.id == selectedDeviceId;
                    });
                    if (curDevice.length === 0) {
                        RED.notify('<strong>Error</strong>: could not find device with id \'' + selectedDeviceId + '\' configured on Telldus device', 'error');
                        return;
                    }
                    curDevice = curDevice[0];
                    $('.node-input-method').show();

                    // Populate method select
                    $('#node-input-method option[value!=""]').remove();
                    Object.keys(curDevice.methods).forEach(function (key) {
                        if (key !== 'learn') {
                            $('#node-input-method')
                                    .append($('<option>', {value: key})
                                            .text(key));
                        }
                    });
                    $('#node-input-method option[value="' + selectedMethod + '"]').prop('selected', true);
                } else {
                    $('.node-input-method').hide();
                }

                showHideDim($("#node-input-method").val())
            }


            /**
             * Show/hide dim input fields, and sync range/text input.
             */
            function showHideDim(currentMethod) {
                if (currentMethod === 'dim') {
                    $("#dimlevel-range").val($("#node-input-dimlevel").val());
                    $('.node-input-dimlevel').show();
                } else {
                    $('.node-input-dimlevel').hide();
                }
            }


            /* ************************************************************* *\
             *
             *  List of Configured Devices Dialog
             *
             \* ************************************************************* */

            /**
             * Configure list configured devices dialog
             */
            $("#telldus-dialog-list-configured-devices").dialog({
                dialogClass: 'telldus-list-configured-device-dialog no-close',
                autoOpen: false,
                modal: true,
                width: 900,
                maxHeight: ($(window).height() - ($(window).height()/10)),
                buttons: [
                    {
                        text: "Add New Device",
                        class: "telldus-btn-add-new-device",
                        click: function() {
                            $("#telldus-dialog-add-edit-device").dialog("open");
                        }
                    },
                    {
                        text: "Done",
                        click: function() {
                            $( this ).dialog( "close" );
                        }
                    }
                ],
                close: function( event, ui ) {
                    console.log('Dialog was closed');
                }
            });


            function statusObjToStr(statusObj) {
                if (statusObj.name === 'OFF') {
                    return '<i class="fa fa-lightbulb-o telldus-status-icon-off telldus-status-icon"></i> Off'
                } else if (statusObj.name === 'ON') {
                    return '<i class="fa fa-lightbulb-o telldus-status-icon-on telldus-status-icon"></i> On'
                } else if (statusObj.name === 'DIM') {
                    return '<i class="fa fa-lightbulb-o telldus-status-icon-on telldus-status-icon"></i> ' + Math.round((statusObj.level / 255) * 100) + '%';
                } else {
                    return 'Unknown'
                }
            }


            function methodObjToButtons(methodObj) {
                var strOut = '';
                if (methodObj.dim && methodObj.turnon && methodObj.turnoff) {
                    strOut += '<a href="#"><i class="fa fa-lightbulb-o telldus-status-icon-off telldus-status-icon telldus-status-icon-button"></i></a>' +
                    '<a href="#"><i class="fa fa-lightbulb-o telldus-status-icon-25 telldus-status-icon telldus-status-icon-button"></i></a>' +
                    '<a href="#"><i class="fa fa-lightbulb-o telldus-status-icon-50 telldus-status-icon telldus-status-icon-button"></i></a>' +
                    '<a href="#"><i class="fa fa-lightbulb-o telldus-status-icon-75 telldus-status-icon telldus-status-icon-button"></i></a>' +
                    '<a href="#"><i class="fa fa-lightbulb-o telldus-status-icon-on telldus-status-icon telldus-status-icon-button"></i></a>';
                } else {
                    if (methodObj.turnoff === true) {
                        strOut += '<a href="#"><i class="fa fa-lightbulb-o telldus-status-icon-off telldus-status-icon telldus-status-icon-button"></i></a>';
                    }
                    if (methodObj.turnon === true) {
                        strOut += '<a href="#"><i class="fa fa-lightbulb-o telldus-status-icon-on telldus-status-icon telldus-status-icon-button"></i></a>';
                    }
                }

                if (methodObj.bell === true) {
                    strOut += '<a href="#"><i class="fa fa-bell-o telldus-status-icon-bell telldus-status-icon telldus-status-icon-button"></i></a>';
                }

                return strOut;
            }


            function methodObjToLearnButton(methodObj) {
                if (methodObj.learn) {
                    return '<a href="#" class="telldus-button">Learn</a>';
                } else {
                    return '';
                }
            }


            /**
             * Get all configured devices from backend, and populate device lists
             */
            var devices = [];
            (function getAllDevices() {
                $.getJSON('telldus/configured-devices',function(data) {
                    devices = data;
                    jqOutputConfigDevices = $('#telldus-output-config-devices');
                    jqNodeInputDevice = $('#node-input-device');
                    data.forEach(function (device) {
                        jqNodeInputDevice
                                .append($('<option>', { value : device.id })
                                        .text(device.name));
                        jqOutputConfigDevices
                                .append(
                                '<tr>' +
                                '<td>' + statusObjToStr(device.status) + '</td>' +
                                '<td><a href="#" class="telldus-link-configure-device" data-tdid="' + device.id +'">' + device.name + '</a></td>' +
                                '<td>' + methodObjToButtons(device.methods) + '</td>' +
                                '<td class="telldus-learn-column">' +
                                methodObjToLearnButton(device.methods) +
                                '</td>' +

                                '<tr>'
                        );
                    });
                    $('#node-input-device option[value="' + node.device + '"]').prop('selected', true);
                    showHideMethods(node.device, node.method);
                });
            })();


            /* ************************************************************* *\
             *
             *  Add/Edit Device Dialog
             *
            \* ************************************************************* */

            /**
             * Configure add/edit device dialog
             */
            $("#telldus-dialog-add-edit-device").dialog({
                dialogClass: 'telldus-add-edit-device-dialog no-close form-horizontal',
                autoOpen: false,
                modal: true,
                width: 700,
                maxHeight: ($(window).height() - ($(window).height()/10)),
                buttons: [
                    {
                        text: "Save Device",
                        click: function() {
                            $( this ).dialog( "close" );
                        }
                    },
                    {
                        text: "Cancel",
                        click: function() {
                            $( this ).dialog( "close" );
                        }
                    }
                ],
                close: function( event, ui ) {
                    console.log('Dialog was closed');
                },
                open: function( event, ui ) {
                    /**
                     * Reset all input fields (if dialog has been opened before)
                     */
                    $('.telldus-addedit-parameter-row').hide();
                    $('#telldus-row-addedit-devices').hide();
                    $('#telldus-addedit-parameter-house-number').val('');
                    $('#telldus-addedit-parameter-house-letter').val('');
                    $('#telldus-addedit-parameter-unit').val('');
                    $('.telldus-code-block input[value="false"]').prop('checked', true);
                    $('.telldus-code-block input[value="true"]').prop('checked', false);

                    /**
                     * Make request to server for all supported Brands and
                     * populate "Brands" select box.
                     */
                    $.getJSON('telldus/supported-brands',function(data) {
                        // todo add error handling
                        var jqSelectBrands = $('#telldus-select-supported-brands');
                        jqSelectBrands.empty();
                        jqSelectBrands.append('<option value=""></option>');
                        data.forEach(function(brand) {
                            jqSelectBrands.append('<option value="' + brand + '">' + brand + '</option>');
                        });
                    });
                }
            });


            /**
             * Event Listener - "Brands" Select Box
             * Update "Device" Select Box when "Brands" Select Box is changed.
             */
            $('#telldus-select-supported-brands').change(function () {
                updateDeviceSelect($(this).find(":selected").val());
            });


            /**
             *  Event Listener - "Devices" Select Box
             */
            $('#telldus-select-supported-devices').change(function () {
                var jqSelectedDevice = $(this).find(":selected");
                getAndDisplayModelParameters(
                        jqSelectedDevice.data('paramhouse'),
                        jqSelectedDevice.data('paramunit'),
                        jqSelectedDevice.data('paramcode')
                );
            });

            function makeNumberIntoRealNumber(str) {
                var maybeNumber = parseFloat(str);
                if (isNaN(maybeNumber)) {
                    return str;
                } else {
                    return maybeNumber;
                }
            }

            /**
             *  Event Listener - Randomize button
             */
            $('.telldus-random-button').click(function () {
                var jqThis = $(this);
                var min = jqThis.data('min');
                var max = jqThis.data('max');
                $('#' + jqThis.data('randomfor')).val(Math.floor(Math.random() * (max - min) + min));
            });

            function isNumber(str) {
                return (typeof str === 'number' && (str % 1) === 0);
            }

            function getAndDisplayModelParameters(house, unit, code) {

                $('.telldus-addedit-parameter-row').hide();

                if (house === undefined && unit === undefined && code === undefined) {
                    return;
                }

                var jqCurrentRow;

                /**
                 * Show "House" input field
                 */
                if (house !== 'undefined' && house !== undefined) {
                    var houseData = house.split('-');
                    if (houseData.length === 2) {
                        if (isNumber(makeNumberIntoRealNumber(houseData[0])) && isNumber(makeNumberIntoRealNumber(houseData[1]))) {
                            /**
                             * House is a number span
                             */
                            jqCurrentRow = $('#telldus-row-addedit-parameter-house-number');
                            jqCurrentRow.find('.telldus-random-button')
                                    .data('min', houseData[0])
                                    .data('max', houseData[1]);
                            jqCurrentRow.find('.telldus-parameter-help-text').text('Number: ' + house);
                            jqCurrentRow.show();
                        } else {
                            /**
                             * House is a letter span
                             */
                            jqCurrentRow = $('#telldus-row-addedit-parameter-house-letter');
                            jqCurrentRow.find('.telldus-parameter-help-text').text('Characters: ' + house);
                            jqCurrentRow.show();
                        }
                    } else {
                        RED.notify('<strong>Telldus error (err: 1)</strong>: "house" could not be understood, Configuration JSON file probably not correct', 'error');
                    }
                }


                /**
                 * Show "Unit" input field
                 */
                if (unit !== 'undefined' && unit !== undefined) {
                    var unitData = unit.split('-');
                    if (unitData.length === 2) {
                        if (isNumber(makeNumberIntoRealNumber(unitData[0])) && isNumber(makeNumberIntoRealNumber(unitData[1]))) {
                            jqCurrentRow = $('#telldus-row-addedit-parameter-unit');
                            jqCurrentRow.find('.telldus-parameter-help-text').text('Number: ' + unit);
                            jqCurrentRow.show();
                        } else {
                            RED.notify('<strong>Telldus error (err: 2)</strong>: "unit" could not be understood, Configuration JSON file probably not correct', 'error');
                        }
                    } else {
                        RED.notify('<strong>Telldus error (err: 3)</strong>: "unit" could not be understood, Configuration JSON file probably not correct', 'error');
                    }
                }


                /**
                 * Show "Code" input field
                 */
//                if (code !== 'undefined' && code !== undefined)
//                telldus-row-addedit-parameter-code
                if (code === true) {
                    jqCurrentRow = $('#telldus-row-addedit-parameter-code');
                    jqCurrentRow.show();
                }

                //(?:0|1){10}

//

//                    $('#telldus-row-addedit-parameter-house-number')
//                    $('#telldus-row-addedit-parameter-unit')



//                    // todo add error handling
//                    var jqSelectBrands = $('#telldus-select-supported-brands');
//                    jqSelectBrands.empty();
//                    jqSelectBrands.append('<option value=""></option>');
//                    data.forEach(function(brand) {
//                        jqSelectBrands.append('<option value="' + brand + '">' + brand + '</option>');
//                    });

            }


            /**
             * Take brand name, make request to the server for all
             * devices of that brand name and populate the "Brands"
             * Select Box with those devices.
             */
            function updateDeviceSelect(brandName, selectedModel) {
                $.getJSON('telldus/supported-devices/' + brandName, function(data) {
                    var jqSelectDevices = $('#telldus-select-supported-devices');
                    jqSelectDevices.empty();
                    data.forEach(function (device) {
                        jqSelectDevices.append(
                            '<option data-brand="' + device.brand +
                            '" data-model="' + device.model +
                            '" data-protocol="' + device.protocol +
                            '" data-type="' + device.type +
                            '" data-paramhouse="' + device.parameters.house +
                            '" data-paramunit="' + device.parameters.unit +
                            '" data-paramcode="' + device.parameters.code +
                            '">' + device.name + '</option>'
                        );
                    });

                    console.dir('UPDATING DEVICE');
                    
                    $('#telldus-row-addedit-devices').show();



                    /**
                     * If no selectedModel is sent in, do a request for the parameters
                     * for the _first_ device in the list. And display the
                     * parameters.
                     */
                    if(!selectedModel) {
                        getAndDisplayModelParameters(
                            data[0].parameters.house,
                            data[0].parameters.unit,
                            data[0].parameters.code
                        );
                    }
                });
            }



        }
    });
</script>
